<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fichaje de Horas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 15px;
            text-align: center;
        }
        button {
            padding: 15px;
            margin: 8px;
            font-size: 16px;
            width: 100%;
        }
        table {
            width: 100%;
            margin-top: 15px;
            background: white;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
        }
        th {
            background: #ddd;
        }
    </style>
</head>
<body>

<h2>â±ï¸ Fichaje de horas</h2>

<button onclick="entrada('Trabajo')">ğŸ­ Entrada trabajo</button>
<button onclick="entrada('Viaje')">ğŸš— Entrada viaje</button>
<button onclick="salida()">ğŸ”´ Salida</button>
<button onclick="exportarExcel()">ğŸ“Š Exportar a Excel</button>
<div id="resumen" style="margin-top:15px;font-weight:bold;"></div>
<div id="estado" style="margin-top:10px;color:#1976d2;font-weight:bold;"></div>
<button id="btnTrabajo" onclick="entrada('Trabajo')">ğŸ­ Entrada trabajo</button>
<button id="btnViaje" onclick="entrada('Viaje')">ğŸš— Entrada viaje</button>
<button id="btnSalida" onclick="salida()">ğŸ”´ Salida</button>

<table>
    <thead>
<tr>
    <th>Fecha</th>
    <th>Tipo</th>
    <th>Entrada</th>
    <th>Salida</th>
    <th>Tiempo</th>
</tr>
</thead>
    <tbody id="tabla"></tbody>
</table>

<script>
let registros = JSON.parse(localStorage.getItem("registros")) || [];
limpiarRegistros();

function actualizarBotones() {
    let r = registros[registros.length - 1];
    let abierto = r && r.entradaTimestamp && !r.salidaTimestamp;

    document.getElementById("btnTrabajo").disabled = abierto;
    document.getElementById("btnViaje").disabled = abierto;
    document.getElementById("btnSalida").disabled = !abierto;
}

function mostrarEstado() {
    let e = document.getElementById("estado");
    let r = registros[registros.length - 1];

    if (r && r.entradaTimestamp && !r.salidaTimestamp) {
        e.innerText = `ğŸŸ¢ ${r.tipo} en curso desde ${r.entradaTexto}`;
    } else {
        e.innerText = "âšª No hay fichaje activo";
    }
}

function entrada(tipo) {
    let ahora = new Date();

    // evitar doble entrada abierta
    let ultima = registros[registros.length - 1];
    if (ultima && !ultima.salidaTimestamp) {
        alert("Ya hay una entrada abierta");
        return;
    }

    registros.push({
        fecha: ahora.toLocaleDateString(),
        tipo,
        entradaTexto: ahora.toLocaleTimeString(),
        salidaTexto: "",
        entradaTimestamp: ahora.getTime(),
        salidaTimestamp: null,
        horas: 0,
        minutos: 0,
        tiempo: ""
    });
    guardar();
}

function salida() {

if (!confirm("Â¿Cerrar fichaje actual?")) return;
    let ahora = new Date();
    let r = registros[registros.length - 1];

    if (!r || r.salidaTimestamp) {
        alert("No hay entrada abierta");
        return;
    }

    r.salidaTimestamp = ahora.getTime();
    r.salidaTexto = ahora.toLocaleTimeString();

    let diffMs = r.salidaTimestamp - r.entradaTimestamp;
    let totalMin = Math.floor(diffMs / 60000);

    r.horas = Math.floor(totalMin / 60);
    r.minutos = totalMin % 60;
    r.tiempo = `${r.horas}h ${r.minutos}m`;

    guardar();
}

function guardar() {
    localStorage.setItem("registros", JSON.stringify(registros));
    mostrar();
    calcularTotales();
    mostrarEstado();
actualizarBotones();
}

function mostrar() {
    let t = document.getElementById("tabla");
    t.innerHTML = "";

    registros.forEach(r => {
        t.insertAdjacentHTML("beforeend", `
        <tr>
            <td>${r.fecha}</td>
            <td>${r.tipo}</td>
            <td>${r.entradaTexto}</td>
            <td>${r.salidaTexto || "-"}</td>
            <td>${r.tiempo || "-"}</td>
        </tr>`);
    });
}

function calcularTotales() {
    let hoy = new Date().toLocaleDateString();
    let trabajo = 0;
    let viaje = 0;

    registros
        .filter(r => r.fecha === hoy && r.salidaTimestamp)
        .forEach(r => {
            let minutos = r.horas * 60 + r.minutos;
            if (r.tipo === "Trabajo") trabajo += minutos;
            if (r.tipo === "Viaje") viaje += minutos;
        });

    let total = trabajo + viaje;

    document.getElementById("resumen").innerText =
        `Hoy â†’ ğŸ­ Trabajo: ${Math.floor(trabajo/60)}h ${trabajo%60}m | ğŸš— Viaje: ${Math.floor(viaje/60)}h ${viaje%60}m | â±ï¸ Total: ${Math.floor(total/60)}h ${total%60}m`;
}

function exportarExcel() {
    if (!registros || registros.length === 0) {
        alert("No hay registros para exportar");
        return;
    }

    const datosExcel = registros.map(r => ({
    Fecha: r.fecha,
    Tipo: r.tipo || "Trabajo",
    Entrada: r.entradaTexto || r.entrada || "",
    Salida: r.salidaTexto || r.salida || "",
    Horas: r.horas ?? 0,
    Minutos: r.minutos ?? 0,
    Tiempo: r.tiempo || ""
    }));

    const ws = XLSX.utils.json_to_sheet(datosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Fichajes");

    XLSX.writeFile(wb, "fichaje.xlsx");}

mostrar();
calcularTotales();
mostrarEstado();
actualizarBotones();

function limpiarRegistros() {
    let cambiado = false;

    registros.forEach(r => {
        // Normalizar entrada
        if (!r.entradaTexto && r.entrada) {
            r.entradaTexto = r.entrada;
            cambiado = true;
        }

        // Normalizar salida
        if (!r.salidaTexto && r.salida) {
            r.salidaTexto = r.salida;
            cambiado = true;
        }

        // Recalcular si hay timestamps
        if (r.entradaTimestamp && r.salidaTimestamp) {
            let diffMs = r.salidaTimestamp - r.entradaTimestamp;
            let totalMin = Math.max(0, Math.floor(diffMs / 60000));

            r.horas = Math.floor(totalMin / 60);
            r.minutos = totalMin % 60;
            r.tiempo = `${r.horas}h ${r.minutos}m`;
        }
    });

    if (cambiado) {
        localStorage.setItem("registros", JSON.stringify(registros));
    }
}

// Registrar service worker
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
