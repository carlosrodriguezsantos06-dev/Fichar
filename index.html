<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fichaje de Horas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 15px;
            text-align: center;
        }
        button {
            padding: 15px;
            margin: 8px;
            font-size: 16px;
            width: 100%;
        }
        table {
            width: 100%;
            margin-top: 15px;
            background: white;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
        }
        th {
            background: #ddd;
        }
    </style>
</head>
<body>

<h2>‚è±Ô∏è Fichaje de horas</h2>

<div id="loginBox" style="margin-bottom:15px;">
  <h3>üîê Iniciar sesi√≥n</h3>
  <input id="email" type="email" placeholder="Email"
         style="width:100%;padding:10px;margin:5px;">
  <input id="password" type="password" placeholder="Contrase√±a"
         style="width:100%;padding:10px;margin:5px;">
  <button onclick="login()">Entrar</button>
</div>

<button id="btnTrabajo" onclick="entrada('Trabajo')">üè≠ Entrada trabajo</button>
<button id="btnViaje" onclick="entrada('Viaje')">üöó Entrada viaje</button>
<button id="btnSalida" onclick="salida()">üî¥ Salida</button>
<button onclick="exportarExcel()">üìä Exportar a Excel</button>
<div id="resumen" style="margin-top:15px;font-weight:bold;"></div>
<div id="estado" style="margin-top:10px;color:#1976d2;font-weight:bold;"></div>


<table>
    <thead>
<tr>
    <th>Fecha</th>
    <th>Tipo</th>
    <th>Entrada</th>
    <th>Salida</th>
    <th>Tiempo</th>
</tr>
</thead>
    <tbody id="tabla"></tbody>
</table>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_STORAGE_BUCKET",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Exponer a la app normal
  window.firebaseAuth = auth;
  window.firebaseDB = db;
  window.firebaseSignIn = signInWithEmailAndPassword;
  window.firebaseOnAuthStateChanged = onAuthStateChanged;
</script>

<script>
let registros = JSON.parse(localStorage.getItem("registros")) || [];
limpiarRegistros();

function actualizarBotones() {
    let r = registros[registros.length - 1];
    let abierto = r && r.entradaTimestamp && !r.salidaTimestamp;

    document.getElementById("btnTrabajo").disabled = abierto;
    document.getElementById("btnViaje").disabled = abierto;
    document.getElementById("btnSalida").disabled = !abierto;
}

function fechaISO(date = new Date()) {
    return date.toISOString().split("T")[0];
}

function mostrar() {
    let t = document.getElementById("tabla");
    t.innerHTML = "";
    let hoy = fechaISO();

    registros
        .filter(r => r.fecha === hoy)
        .forEach(r => {
            t.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${new Date(r.fecha).toLocaleDateString()}</td>
                <td>${r.tipo}</td>
                <td>${r.entradaTexto}</td>
                <td>${r.salidaTexto || "-"}</td>
                <td>${r.tiempo || "-"}</td>
            </tr>`);
        });
}

function entrada(tipo) {
    let ahora = new Date();

    let ultima = registros[registros.length - 1];
    if (ultima && !ultima.salidaTimestamp) {
        alert("Ya hay una entrada abierta");
        return;
    }

    registros.push({
        fecha: fechaISO(ahora),
        tipo,
        entradaTexto: ahora.toLocaleTimeString(),
        salidaTexto: "",
        entradaTimestamp: ahora.getTime(),
        salidaTimestamp: null,
        horas: 0,
        minutos: 0,
        tiempo: ""
    });

    guardar();
}

function salida() {

    if (!confirm("¬øCerrar fichaje actual?")) return;

    let r = registros[registros.length - 1];

    if (!r || !r.entradaTimestamp || r.salidaTimestamp) {
        alert("No hay entrada abierta");
        return;
    }

    let ahora = new Date();

    r.salidaTimestamp = ahora.getTime();
    r.salidaTexto = ahora.toLocaleTimeString();

    let diffMs = r.salidaTimestamp - r.entradaTimestamp;
    let totalMin = Math.floor(diffMs / 60000);

    r.horas = Math.floor(totalMin / 60);
    r.minutos = totalMin % 60;
    r.tiempo = `${r.horas}h ${r.minutos}m`;

    guardar();
}

function guardar() {
    localStorage.setItem("registros", JSON.stringify(registros));
    mostrar();
    calcularTotales();
    mostrarEstado();
    actualizarBotones();
}


function calcularTotales() {
    let hoy = fechaISO();
    let trabajo = 0;
    let viaje = 0;

    registros
        .filter(r => r.fecha === hoy && r.salidaTimestamp)
        .forEach(r => {
            let minutos = r.horas * 60 + r.minutos;
            if (r.tipo === "Trabajo") trabajo += minutos;
            if (r.tipo === "Viaje") viaje += minutos;
        });

    let total = trabajo + viaje;

    document.getElementById("resumen").innerText =
        `Hoy ‚Üí üè≠ Trabajo: ${Math.floor(trabajo/60)}h ${trabajo%60}m | üöó Viaje: ${Math.floor(viaje/60)}h ${viaje%60}m | ‚è±Ô∏è Total: ${Math.floor(total/60)}h ${total%60}m`;
}

function exportarExcel() {
    if (!registros || registros.length === 0) {
        alert("No hay registros para exportar");
        return;
    }

    const datosExcel = registros.map(r => ({
    Fecha: r.fecha,
    Tipo: r.tipo || "Trabajo",
    Entrada: r.entradaTexto || r.entrada || "",
    Salida: r.salidaTexto || r.salida || "",
    Horas: r.horas ?? 0,
    Minutos: r.minutos ?? 0,
    Tiempo: r.tiempo || ""
    }));

    const ws = XLSX.utils.json_to_sheet(datosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Fichajes");

    XLSX.writeFile(wb, "fichaje.xlsx");}

mostrar();
calcularTotales();
mostrarEstado();
actualizarBotones();

function limpiarRegistros() {
    let cambiado = false;

    registros.forEach(r => {
        // Normalizar entrada
        if (!r.entradaTexto && r.entrada) {
            r.entradaTexto = r.entrada;
            cambiado = true;
        }

        // Normalizar salida
        if (!r.salidaTexto && r.salida) {
            r.salidaTexto = r.salida;
            cambiado = true;
        }

        // Recalcular si hay timestamps
        if (r.entradaTimestamp && r.salidaTimestamp) {
            let diffMs = r.salidaTimestamp - r.entradaTimestamp;
            let totalMin = Math.max(0, Math.floor(diffMs / 60000));

            r.horas = Math.floor(totalMin / 60);
            r.minutos = totalMin % 60;
            r.tiempo = `${r.horas}h ${r.minutos}m`;
        }
    });

    if (cambiado) {
        localStorage.setItem("registros", JSON.stringify(registros));
    }
}

// Registrar service worker
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    if (!email || !password) {
        alert("Introduce email y contrase√±a");
        return;
    }

    window.firebaseSignIn(window.firebaseAuth, email, password)
        .catch(err => alert(err.message));
}
window.firebaseOnAuthStateChanged(window.firebaseAuth, user => {
    const loginBox = document.getElementById("loginBox");

    if (user) {
        // Usuario conectado
        loginBox.style.display = "none";
        console.log("Usuario logueado:", user.email);
    } else {
        // Usuario NO conectado
        loginBox.style.display = "block";
    }
});
</script>

</body>
</html>
