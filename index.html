<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fichaje de Horas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 15px;
            text-align: center;
        }
        button {
            padding: 15px;
            margin: 8px;
            font-size: 16px;
            width: 100%;
        }
        table {
            width: 100%;
            margin-top: 15px;
            background: white;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
        }
        th {
            background: #ddd;
        }
    </style>
</head>
<body>

<h2>‚è±Ô∏è Fichaje de horas</h2>

<button onclick="entrada('Trabajo')">üè≠ Entrada trabajo</button>
<button onclick="entrada('Viaje')">üöó Entrada viaje</button>
<button onclick="salida()">üî¥ Salida</button>
<button onclick="exportarExcel()">üìä Exportar a Excel</button>

<table>
    <thead>
<tr>
    <th>Fecha</th>
    <th>Tipo</th>
    <th>Entrada</th>
    <th>Salida</th>
    <th>Tiempo</th>
</tr>
</thead>
    <tbody id="tabla"></tbody>
</table>

<script>
let registros = JSON.parse(localStorage.getItem("registros")) || [];

function entrada(tipo) {
    let ahora = new Date();
    registros.push({
        fecha: ahora.toLocaleDateString(),
        tipo: tipo,
        entrada: ahora.toLocaleTimeString(),
        salida: "",
        horas: 0,
        minutos: 0,
        tiempo: ""
    });
    guardar();
}

function salida() {
    let ahora = new Date();
    let r = registros[registros.length - 1];

    if (!r || r.salida) {
        alert("No hay entrada abierta");
        return;
    }

    r.salida = ahora.toLocaleTimeString();

    // Parsear horas y minutos desde r.entrada y r.salida
    const [hEntrada, mEntrada, sEntrada] = r.entrada.split(":").map(Number);
    const [hSalida, mSalida, sSalida] = r.salida.split(":").map(Number);

    let inicio = new Date();
    inicio.setHours(hEntrada, mEntrada, sEntrada, 0);

    let fin = new Date();
    fin.setHours(hSalida, mSalida, sSalida, 0);

    // Diferencia en minutos
    let diffMs = fin - inicio;
    let totalMin = Math.floor(diffMs / 60000);

    let horas = Math.floor(totalMin / 60);
    let minutos = totalMin % 60;

    r.horas = horas;
    r.minutos = minutos;
    r.tiempo = `${horas}h ${minutos}m`;

    guardar();
}

function guardar() {
    localStorage.setItem("registros", JSON.stringify(registros));
    mostrar();
}

function mostrar() {
    let t = document.getElementById("tabla");
    t.innerHTML = "";
    registros.forEach(r => {
        t.innerHTML += `
        <tr>
            <td>${r.fecha}</td>
            <td>${r.tipo}</td>
            <td>${r.entrada}</td>
            <td>${r.salida}</td>
            <td>${r.tiempo}</td>
        </tr>`;
    });
}

function exportarExcel() {
    // 1Ô∏è‚É£ Datos principales
    let datosExcel = registros.map(r => ({
        Fecha: r.fecha,
        Tipo: r.tipo,
        Entrada: r.entrada,
        Salida: r.salida,
        Horas: r.horas,
        Minutos: r.minutos,
        Tiempo: r.tiempo
    }));

    // 2Ô∏è‚É£ Crear hoja
    let ws = XLSX.utils.json_to_sheet(datosExcel);

    // 3Ô∏è‚É£ Crear totales por fecha y tipo
    let resumen = {};
    registros.forEach(r => {
        let key = r.fecha + " | " + r.tipo;
        if (!resumen[key]) resumen[key] = {horas: 0, minutos: 0};
        resumen[key].horas += r.horas;
        resumen[key].minutos += r.minutos;
    });

    // Ajustar minutos > 60
    Object.keys(resumen).forEach(k => {
        let h = resumen[k].horas;
        let m = resumen[k].minutos;
        h += Math.floor(m / 60);
        m = m % 60;
        resumen[k].horas = h;
        resumen[k].minutos = m;
        resumen[k].tiempo = `${h}h ${m}m`;
    });

    // 4Ô∏è‚É£ A√±adir fila vac√≠a
    let filaInicio = registros.length + 2;
    XLSX.utils.sheet_add_aoa(ws, [[""]], {origin: filaInicio});

    // 5Ô∏è‚É£ Escribir totales
    XLSX.utils.sheet_add_aoa(ws, [["Totales por d√≠a y tipo"]], {origin: filaInicio + 1});
    let fila = filaInicio + 2;
    Object.keys(resumen).forEach(k => {
        XLSX.utils.sheet_add_aoa(ws, [[k, resumen[k].tiempo]], {origin: "A" + fila});
        fila++;
    });

    // 6Ô∏è‚É£ Guardar archivo
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Fichajes");
    XLSX.writeFile(wb, "fichaje_totales.xlsx");
}

mostrar();

// Registrar service worker
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
